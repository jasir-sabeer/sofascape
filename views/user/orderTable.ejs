<style>
    .section-top-border {
        margin: 2cm;
    }

    .last {
        margin-left: 15cm;
        margin-top: 2cm;
    }

    .lastdate {
        margin-left: 15cm;

    }

    #viwemore {
        margin-left: 25cm;
    }

    #btn {
        margin-left: 27cm;

    }
</style>
<%- include("../../views/partials/user/header") %>

    <div class="section-top-border">
        <h2 class="mb-30">Your Orders</h2>
        <% if(orders.length>0){%>
            <% orders.forEach(order=> { %>
                <h5 class="country">OrderId :<%= order._id%>
                </h5>
                <div class="progress-table-wrap " id="table">
                    <div class="progress-table">
                        <div class="table-head">
                            <div class="serial">#</div>
                            <div class="percentage">Products</div>
                            <div class="percentage">quantity</div>
                            <div class="country">Price</div>
                            <div class="country">Status</div>
                            <div class="country">Cancel</div>


                        </div>
                        <% let count=1%>
                            <% order.products.forEach(product=> { %>
                                <div class="table-row">
                                    <div class="serial">
                                        <%= count++ %>
                                    </div>
                                    <div class="percentage"> <img src="/uploads/<%= product.productId.images[0] %>"
                                            alt="flag" style="width: 1.5cm;">
                                        <%= product.name %>
                                    </div>
                                    <div class="percentage">
                                        <%= product.quantity%>
                                    </div>
                                    <%if(product.offerPrice ){%>
                                        <div class="country">
                                            <%= product.offerPrice * product.quantity %>
                                        </div>
                                        <%}else{%>
                                            <div class="country">
                                                <%= product.price * product.quantity %>
                                            </div>
                                            <%}%>
                                                <div class="country">
                                                    <%= product.status %>
                                                </div>
                                                <% if(product.status==="Cancelled" ){%>
                                                    <div class="country">
                                                        <th> <span>Cancelled</span></th>
                                                    </div>
                                                    <%}else{%>
                                                        <div class="country"><button
                                                                onclick="cancelProduct('<%= order._id %>', '<%= product.productId._id %>')"
                                                                class="genric-btn danger-border circle"> Cancel</button>
                                                        </div>
                                                        <%}%>


                                </div>
                                <% }); %>
                                    <%if(order.finalDiscountAmount){%>
                                        <p class="last">Total Amount:<%= order.finalDiscountAmount %>
                                        </p>
                                        <%}else{%>
                                            <p class="last">Total Amount:<%= order.total %>
                                            </p>
                                            <%}%>
                                                <% if(order.paymentMethod=='COD' ){%>
                                                    <p class="lastdate">payment Method:Cash on Delivery</p>
                                                    <%}else{%>
                                                        <p class="lastdate">payment Method:<%=order.paymentMethod%>
                                                        </p>
                                                        <%}%>
                                                            <% if(order.paymentStatus==='Failed' ){%>
                                                                <div id="viwemore" class="country">
                                                                    <button class="genric-btn warning circle" id="retryPaymentBtn" type="submit"  data-order-id="<%= order._id%>">Retry
                                                                        Payment</button>
                                                                </div>
                                                                <div id="viwemore" class="country"
                                                                    style="margin-top: .5cm;"><a
                                                                        href="/orderDetails/<%= order._id %>"
                                                                        class="genric-btn success-border circle">View
                                                                        More</a></div>
                                                                <%}else{%>
                                                                    <div id="viwemore" class="country"
                                                                        style="margin-top: .5cm;"><a
                                                                            href="/orderDetails/<%= order._id %>"
                                                                            class="genric-btn success-border circle">View
                                                                            More</a></div>

                                                                    <%}%>
                    </div>

                </div>
                <% }); %>
                    <%}else{%>
                        <div>
                            <p colspan="4" style="margin-left: 9cm;font-size: 18px;">Your Orders is empty....! Please
                                add products </p><br>
                            <a href="/products" class="genric-btn primary e-large" style="margin-left: 12cm;">SHOP
                                NOW</a>
                        </div>
                        <%}%>

    </div>
    <a href="/homepage" id="btn" class="genric-btn default circle">Back To Home</a>







    <%- include("../../views/partials/user/footer") %>
        <script>
            async function cancelProduct(orderId, productId) {


                try {
                    const result = await Swal.fire({
                        title: "Are you sure you want to cancel the product?",
                        showCancelButton: true,
                        confirmButtonColor: '#000',
                        cancelButtonColor: '#000',
                        confirmButtonText: "OK",
                    });

                    if (result.isConfirmed) {
                        await fetch(`/cancelOrder/${orderId}/${productId}`, {
                                                        method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        })
                            .then(response => {
                                if (response.ok) {
                                    location.reload();
                                } else {
                                    alert('Failed to cancel the product');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred');
                            });
                    }
                } catch (error) {
                    console.log('Error in cancel product:', error);
                }
            }

        </script>

        <script>
    document.getElementById("retryPaymentBtn").addEventListener("click", function (e) {
    e.preventDefault();

    const orderId = e.target.getAttribute('data-order-id');
    if (!orderId) {
        Swal.fire({
            title: 'Error!',
            text: 'Invalid Order ID. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }

    fetch(`/razorpay/retry/${orderId}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to create Razorpay order');
        }
       
       



        const razorpayOptions = {
            key: 'rzp_test_PK79kuFlXvgTpG',
            amount: data.amount,
            
            currency: 'INR',
            name: 'Sofascape',
            description: 'Order Payment',
            order_id: data.orderId,
            handler: function (response) {
                            if (orderId) {
                                fetch("/payment-sucsess", {
                                    method: "POST",
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_signature: response.razorpay_signature,
                                        orderId: orderId
                                    })
                                })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.success) {
                                            window.location.href =  `/thankyou?orderId=${data.orderId}`;
                                        } else {
                                            alert('Payment verification failed');
                                            window.location.href = '/orderTable';
                                        }
                                    })
                                    .catch(error => console.error('Error verifying payment:', error));
                            }
                        },
            prefill: {
                name:  'John Doe', // Example dynamic value
                email:  'john.doe@example.com',
                contact:   '9999999999'
            },
            modal: {
                ondismiss: function () {
                    handlePaymentFailure(data.orderData, 'Failed');
                }
            }
        };

        const razorpay = new Razorpay(razorpayOptions);
        console.log("this is from razorpy  order",razorpayOptions);
        razorpay.open();
    })
 
    
    .catch(error => {
        console.error('Error in Razorpay integration:', error.message);
        Swal.fire({
            title: 'Error!',
            text: 'Failed to initialize Razorpay. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
});



 </script>
 <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
